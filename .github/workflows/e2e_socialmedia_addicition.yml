name: Socialmedia Addiction

on:
    push:
        branches: ["main"]
    workflow_dispatch:

env:
  GROUP: "HAC9909-MasterclassDeployingAISolutions"
  WORKSPACE: "vandaele-thijs-ml"
  LOCATION: "WestEurope"
  dockerregistry: ghcr.io/thijsvandaele8/mlops-animals-api

jobs:
    Azure-ML-setup:
        runs-on: self-hosted
        steps:
          - name: Check out repo
            uses: actions/checkout@v4

          - name: Azure Login
            uses: azure/login@v1
            with:
             creds: ${{ secrets.AZURE_CREDENTIALS }}

          - name: Check if azure ml extension is installed
            run: az extension add --name ml

          - name: Azure configure defaults
            run: az configure --defaults group=${{ env.GROUP }} workspace=${{ env.WORKSPACE }} location=${{ env.LOCATION }}

          - name: Create compute
            run: az ml compute create --file ./azml/environment/compute/compute.yaml

          - name: Ensure compute is running
            run: | 
                  $STATE=$(az ml compute show --name default-machine-cli --query "state" -o tsv)

                    if($STATE -ne "Running")
                    {
                        echo "Compute is not running"
                        az ml compute start --name default-machine-cli
                    }

                    echo "Compute is running"


             